---
import BaseLayout from './BaseLayout.astro';
import { siteConfig } from '../data/site';
import { getCollection } from 'astro:content';
import WhatsAppIcon from '../components/icons/WhatsAppIcon.astro';

interface Props {
  title: string;
  description: string;
  seoTitle?: string;
  seoDescription?: string;
  seoKeywords?: string;
  heroImage?: string;
  category: string;
  slug: string;
}

const {
  title,
  description,
  seoTitle,
  seoDescription,
  seoKeywords,
  heroImage,
  category,
  slug,
} = Astro.props;

const categoryLabels: Record<string, string> = {
  corporales: 'Procedimientos Corporales',
  faciales: 'Procedimientos Faciales',
  intimos: 'Procedimientos Íntimos',
  mamarios: 'Cirugías Mamarias',
};

const categoryShortLabels: Record<string, string> = {
  corporales: 'Corporales',
  faciales: 'Faciales',
  intimos: 'Íntimos',
  mamarios: 'Mamarias',
};

const categoryHrefs: Record<string, string> = {
  corporales: '/procedimientos-corporales/',
  faciales: '/procedimientos-faciales/',
  intimos: '/procedimientos-intimos/',
  mamarios: '/procedimientos-mamarios/',
};

const collectionNames: Record<string, string> = {
  corporales: 'procedimientos-corporales',
  faciales: 'procedimientos-faciales',
  intimos: 'procedimientos-intimos',
  mamarios: 'procedimientos-mamarios',
};

// Fetch related procedures from the same category (excluding current)
const collectionName = collectionNames[category];
let relatedProcedures: { slug: string; title: string; description: string; thumbnailImage: string }[] = [];

if (collectionName) {
  const allInCategory = await getCollection(collectionName as any);
  const others = allInCategory
    .filter((p: any) => p.data.slug !== slug && !p.data.draft)
    .sort(() => Math.random() - 0.5)
    .slice(0, 3);
  relatedProcedures = others.map((p: any) => ({
    slug: p.data.slug,
    title: p.data.title,
    description: p.data.description,
    thumbnailImage: p.data.thumbnailImage,
  }));
}

// Fetch related blog articles by matching category keywords
const categoryKeywords: Record<string, string[]> = {
  corporales: ['corporal', 'liposucción', 'abdominoplastia', 'corporal'],
  faciales: ['facial', 'rostro', 'botox', 'relleno', 'lifting', 'blefaroplastia', 'armonización'],
  intimos: ['íntimo', 'intimo', 'ginecológico', 'vaginal', 'labioplastia', 'gineco'],
  mamarios: ['mamaria', 'mamario', 'seno', 'pecho', 'mama', 'implante'],
};

const allBlogPosts = await getCollection('blog', ({ data }) => !data.draft);
const keywords = categoryKeywords[category] || [];
const relatedBlogPosts = allBlogPosts
  .filter((post) => {
    const titleLower = post.data.title.toLowerCase();
    const descLower = post.data.description.toLowerCase();
    const catsLower = post.data.categories.map((c: string) => c.toLowerCase());
    return keywords.some((kw) =>
      titleLower.includes(kw) || descLower.includes(kw) || catsLower.some((c: string) => c.includes(kw))
    );
  })
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 3);
---

<BaseLayout
  title={seoTitle || title}
  description={seoDescription || description}
  image={heroImage}
  keywords={seoKeywords}
>
  <!-- BreadcrumbList + MedicalProcedure Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "BreadcrumbList",
        "itemListElement": [
          {
            "@type": "ListItem",
            "position": 1,
            "name": "Inicio",
            "item": siteConfig.url,
          },
          {
            "@type": "ListItem",
            "position": 2,
            "name": categoryLabels[category],
            "item": `${siteConfig.url}${categoryHrefs[category]}`,
          },
          {
            "@type": "ListItem",
            "position": 3,
            "name": title,
          },
        ],
      },
      {
        "@type": "MedicalProcedure",
        "name": title,
        "description": description,
        "image": heroImage ? new URL(heroImage, siteConfig.url).href : undefined,
        "url": `${siteConfig.url}${categoryHrefs[category]}${slug}/`,
        "provider": {
          "@id": `${siteConfig.url}/#organization`,
        },
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": `${siteConfig.url}${categoryHrefs[category]}${slug}/`,
        },
      },
    ],
  })} />

  <!-- Hero -->
  <section class="relative overflow-hidden bg-primary-950 pt-32 pb-20 md:pt-40 md:pb-28">
    {heroImage && (
      <img
        src={heroImage}
        alt=""
        class="absolute inset-0 h-full w-full object-cover opacity-40"
        loading="eager"
        decoding="async"
      />
    )}
    <div class="absolute inset-0 bg-gradient-to-br from-primary-950/60 via-primary-900/45 to-primary-800/30" />
    <div class="relative mx-auto max-w-4xl px-6 text-left md:text-center">
      <!-- Breadcrumb -->
      <nav class="mb-6 flex items-center gap-2 text-sm text-primary-300 md:justify-center" aria-label="Breadcrumb">
        <a href="/" class="shrink-0 hover:text-white transition-colors">Inicio</a>
        <svg class="h-3 w-3 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
        </svg>
        <a href={categoryHrefs[category]} class="shrink-0 hover:text-white transition-colors">
          <span class="hidden sm:inline">{categoryLabels[category]}</span>
          <span class="sm:hidden">{categoryShortLabels[category]}</span>
        </a>
        <svg class="h-3 w-3 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
        </svg>
        <span class="truncate text-white">{title}</span>
      </nav>
      <h1 class="font-display text-3xl font-bold text-white md:text-5xl">{title}</h1>
      <p class="mt-4 text-lg text-primary-100 md:text-xl">{description}</p>
    </div>
  </section>

  <!-- Quick Action Bar -->
  <section class="border-b border-neutral-100 bg-white">
    <div class="mx-auto flex max-w-4xl items-center justify-center gap-3 px-6 py-4">
      <a
        href={siteConfig.contact.schedulingUrl}
        target="_blank"
        rel="noopener noreferrer"
        data-gtm="cta-scheduling"
        data-gtm-location="procedure-action-bar"
        class="inline-flex items-center gap-2 rounded-full bg-primary-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition-all hover:scale-105 hover:bg-primary-700 hover:shadow-md"
      >
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
        </svg>
        Agenda tu Evaluación
      </a>
      <a
        href={siteConfig.contact.whatsappHref}
        target="_blank"
        rel="noopener noreferrer"
        data-gtm="cta-whatsapp"
        data-gtm-location="procedure-action-bar"
        class="inline-flex items-center gap-2 rounded-full border border-neutral-200 bg-white px-5 py-2.5 text-sm font-semibold text-neutral-700 transition-all hover:border-[#25d366] hover:text-[#25d366]"
      >
        <WhatsAppIcon class="h-4 w-4" />
        <span class="hidden sm:inline">WhatsApp</span>
      </a>
      <a
        href={siteConfig.contact.phoneHref}
        data-gtm="cta-phone"
        data-gtm-location="procedure-action-bar"
        class="hidden items-center gap-1.5 text-sm text-neutral-500 transition-colors hover:text-primary-700 sm:inline-flex"
      >
        <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
        </svg>
        {siteConfig.contact.phone}
      </a>
    </div>
  </section>

  <!-- Content -->
  <section class="mx-auto max-w-4xl px-6 py-16 md:py-24">
    <div class="prose prose-lg mx-auto">
      <slot />
    </div>

    <!-- CTA -->
    <div class="mt-16 rounded-2xl bg-gradient-to-r from-primary-600 to-primary-700 px-6 py-8 text-center sm:p-8 md:p-12">
      <h2 class="font-display text-2xl font-bold text-white md:text-3xl" style="color: #ffffff; border: none; padding: 0; margin: 0;">
        ¿Te interesa este procedimiento?
      </h2>
      <p class="mt-3 text-primary-100">
        Agenda una evaluación gratuita y sin compromiso con nuestros especialistas.
      </p>
      <a
        href={siteConfig.contact.whatsappHref}
        target="_blank"
        rel="noopener noreferrer"
        data-gtm="cta-whatsapp"
        data-gtm-location="procedure-bottom-cta"
        class="mt-6 inline-flex items-center justify-center gap-2.5 whitespace-nowrap rounded-full bg-white px-6 py-3 text-sm font-semibold text-primary-700 transition-transform hover:scale-105 sm:px-8 sm:py-3.5 sm:text-base"
      >
        <WhatsAppIcon class="h-5 w-5 shrink-0 text-primary-600" />
        <span class="hidden sm:inline">Agenda tu Evaluación Gratuita</span>
        <span class="sm:hidden">Agendar Evaluación</span>
      </a>
    </div>
  </section>

  <!-- Related Blog Articles -->
  {relatedBlogPosts.length > 0 && (
    <section class="border-t border-neutral-100 py-14 md:py-18">
      <div class="mx-auto max-w-4xl px-6">
        <p class="text-center text-xs font-semibold uppercase tracking-[0.2em] text-neutral-400">
          Artículos Relacionados
        </p>
        <div class="mt-8 divide-y divide-neutral-100">
          {relatedBlogPosts.map((post) => (
            <a
              href={`/blog/${post.data.slug}/`}
              class="group flex gap-4 py-5 transition-colors first:pt-0 last:pb-0"
            >
              {post.data.thumbnailImage && (
                <div class="hidden shrink-0 overflow-hidden rounded-lg sm:block sm:h-16 sm:w-24">
                  <img
                    src={post.data.thumbnailImage}
                    alt={post.data.title}
                    class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                    loading="lazy"
                    decoding="async"
                  />
                </div>
              )}
              <div class="flex flex-col justify-center">
                <h3 class="font-display text-sm font-semibold text-neutral-900 transition-colors group-hover:text-primary-700" style="color: inherit;">
                  {post.data.title}
                </h3>
                <p class="mt-1 line-clamp-1 text-xs text-neutral-400">{post.data.description}</p>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Related Procedures -->
  {relatedProcedures.length > 0 && (
    <section class="border-t border-neutral-100 bg-neutral-50 py-14 md:py-18">
      <div class="mx-auto max-w-6xl px-6">
        <div class="text-center">
          <p class="text-sm font-semibold uppercase tracking-[0.15em] text-primary-600">Más Procedimientos</p>
          <h2 class="mt-2 font-display text-2xl font-bold text-neutral-950 md:text-3xl" style="color: var(--color-neutral-950); border: none; padding: 0;">
            Otros {categoryLabels[category]}
          </h2>
        </div>
        <div class="mt-8 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
          {relatedProcedures.map((proc) => (
            <a
              href={`${categoryHrefs[category]}${proc.slug}/`}
              class="group flex gap-4 overflow-hidden rounded-xl bg-white p-3 shadow-sm ring-1 ring-neutral-100 transition-all duration-300 hover:-translate-y-0.5 hover:shadow-md"
            >
              <div class="h-20 w-20 shrink-0 overflow-hidden rounded-lg">
                <img
                  src={proc.thumbnailImage}
                  alt={proc.title}
                  class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                  loading="lazy"
                  decoding="async"
                />
              </div>
              <div class="flex flex-col justify-center min-w-0">
                <h3 class="font-display text-sm font-bold text-neutral-900 group-hover:text-primary-700 transition-colors" style="color: inherit;">
                  {proc.title}
                </h3>
                <p class="mt-1 line-clamp-2 text-xs leading-relaxed text-neutral-500">{proc.description}</p>
              </div>
            </a>
          ))}
        </div>
        <div class="mt-8 text-center">
          <a
            href={categoryHrefs[category]}
            class="inline-flex items-center gap-2 rounded-full border border-primary-200 bg-white px-6 py-3 text-sm font-semibold text-primary-700 transition-all hover:bg-primary-50 hover:border-primary-300"
          >
            Ver todos los {categoryLabels[category].toLowerCase()}
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
            </svg>
          </a>
        </div>
      </div>
    </section>
  )}
</BaseLayout>
