---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import { siteConfig } from '../../data/site';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.data.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

function formatDate(date: Date): string {
  return date.toLocaleDateString('es-CL', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

// Estimate reading time (~200 words/min for Spanish)
const wordCount = post.body?.split(/\s+/).length ?? 0;
const readingTime = Math.max(1, Math.ceil(wordCount / 200));

// Author data: normalize names and map to real photos
const authorMap: Record<string, { name: string; photo: string; role: string }> = {
  'david bendov': {
    name: 'Dr. David Bendov',
    photo: '/images/site/dr-david-bendov.webp',
    role: 'Cirujano Plástico',
  },
  'myriam colodro': {
    name: 'Dra. Myriam Colodro',
    photo: '/images/site/dra-myriam-colodro.webp',
    role: 'Médico Estético',
  },
  'dr eduardo costa edwards': {
    name: 'Dr. Eduardo Costa Edwards',
    photo: '/images/site/dr-eduardo-costa.webp',
    role: 'Ginecólogo Estético',
  },
  'mabelsuarez': {
    name: 'Dra. Mabel Suárez',
    photo: '/images/site/dra-mabel-suarez.webp',
    role: 'Oftalmóloga Oculoplástica',
  },
};

const authorKey = post.data.author.toLowerCase().trim();
const author = authorMap[authorKey] ?? {
  name: post.data.author,
  photo: '',
  role: siteConfig.name,
};

// Get related posts (same category, excluding current)
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const relatedPosts = allPosts
  .filter((p) => p.data.slug !== post.data.slug && p.data.categories.some((cat: string) => post.data.categories.includes(cat)))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 3);
---

<BaseLayout
  title={post.data.seoTitle || post.data.title}
  description={post.data.seoDescription || post.data.description}
  image={post.data.heroImage || post.data.thumbnailImage}
  type="article"
  publishedTime={post.data.date.toISOString()}
>
  <!-- BlogPosting Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": post.data.title,
    "description": post.data.description,
    "image": post.data.thumbnailImage ? new URL(post.data.thumbnailImage, siteConfig.url).href : undefined,
    "datePublished": post.data.date.toISOString(),
    "author": {
      "@type": "Person",
      "name": author.name,
      "jobTitle": author.role,
      "image": author.photo ? new URL(author.photo, siteConfig.url).href : undefined,
      "worksFor": {
        "@type": "Organization",
        "name": siteConfig.name,
      },
    },
    "publisher": {
      "@id": `${siteConfig.url}/#organization`,
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": new URL(`/blog/${post.data.slug}/`, siteConfig.url).href,
    },
    "inLanguage": "es",
  })} />

  <!-- Editorial Header -->
  <article class="pt-32 md:pt-40">
    <header class="mx-auto max-w-3xl px-6 text-center">
      <!-- Category + Date row -->
      <div class="flex items-center justify-center gap-3 text-sm">
        {post.data.categories.length > 0 && (
          <span class="font-semibold uppercase tracking-[0.12em] text-primary-600">
            {post.data.categories[0]}
          </span>
        )}
        {post.data.categories.length > 0 && (
          <span class="text-neutral-300">|</span>
        )}
        <time datetime={post.data.date.toISOString()} class="text-neutral-400">
          {formatDate(post.data.date)}
        </time>
      </div>

      <!-- Title -->
      <h1 class="mt-5 font-display text-3xl font-bold leading-tight text-neutral-950 md:text-4xl lg:text-[2.75rem] lg:leading-[1.15]">
        {post.data.title}
      </h1>

      <!-- Description -->
      <p class="mt-5 text-lg leading-relaxed text-neutral-500 md:text-xl">
        {post.data.description}
      </p>

      <!-- Author & Reading time -->
      <div class="mt-8 flex items-center justify-center gap-3">
        {author.photo ? (
          <img
            src={author.photo}
            alt={author.name}
            class="h-10 w-10 rounded-full object-cover"
            loading="eager"
          />
        ) : (
          <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary-100 text-primary-600">
            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
            </svg>
          </div>
        )}
        <div class="text-left text-sm">
          <p class="font-medium text-neutral-700">{author.name}</p>
          <p class="text-neutral-400">{readingTime} min de lectura</p>
        </div>
      </div>
    </header>

    <!-- Featured Image -->
    {post.data.thumbnailImage && (
      <div class="mx-auto mt-10 max-w-4xl px-6">
        <div class="overflow-hidden rounded-2xl">
          <img
            src={post.data.thumbnailImage}
            alt={post.data.title}
            class="w-full object-cover"
            loading="eager"
          />
        </div>
      </div>
    )}

    <!-- Divider -->
    <div class="mx-auto mt-10 max-w-3xl px-6">
      <div class="border-t border-neutral-100" />
    </div>

    <!-- Article Content -->
    <div class="mx-auto max-w-2xl px-6 py-12 md:py-16">
      <div class="blog-prose prose prose-lg prose-neutral max-w-none">
        <Content />
      </div>
    </div>


  </article>

  <!-- Related Posts -->
  {relatedPosts.length > 0 && (
    <aside class="border-t border-neutral-100 py-16 md:py-20">
      <div class="mx-auto max-w-4xl px-6">
        <p class="text-center text-xs font-semibold uppercase tracking-[0.2em] text-neutral-400">
          Sigue leyendo
        </p>

        <div class="mt-10 divide-y divide-neutral-100">
          {relatedPosts.map((related) => (
            <a
              href={`/blog/${related.data.slug}/`}
              class="group flex gap-5 py-6 transition-colors first:pt-0 last:pb-0"
            >
              {related.data.thumbnailImage && (
                <div class="hidden shrink-0 overflow-hidden rounded-lg sm:block sm:h-20 sm:w-28">
                  <img
                    src={related.data.thumbnailImage}
                    alt={related.data.title}
                    class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                    loading="lazy"
                    decoding="async"
                  />
                </div>
              )}
              <div class="flex flex-col justify-center">
                <h3 class="font-display text-base font-semibold text-neutral-900 transition-colors group-hover:text-primary-700">
                  {related.data.title}
                </h3>
                <p class="mt-1 line-clamp-1 text-sm text-neutral-400">{related.data.description}</p>
              </div>
            </a>
          ))}
        </div>
      </div>
    </aside>
  )}
</BaseLayout>
